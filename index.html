<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro - Dashboard</title>
    
    <!-- Tailwind CSS (Versão Completa - CDN Play) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-zinc-100 dark:bg-zinc-900 text-zinc-800 dark:text-zinc-200 antialiased">

    <!-- Modal de Termos de Uso -->
    <div id="terms-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden opacity-0">
        <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 transform transition-all scale-95 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center border-b border-zinc-200 dark:border-zinc-700 pb-4 mb-4">
                <h2 class="text-2xl font-bold text-zinc-900 dark:text-white">Termos de Uso – Controle Financeiro</h2>
                <button id="close-terms-modal" class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700">
                    <svg class="w-6 h-6 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="prose dark:prose-invert overflow-y-auto pr-4 text-zinc-600 dark:text-zinc-300">
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">1. Aceitação dos Termos</h3>
                <p>Ao se cadastrar e utilizar a plataforma Controle Financeiro, o usuário declara que leu, entendeu e concorda com os presentes Termos de Uso, bem como com a nossa Política de Privacidade.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">2. Objeto do Serviço</h3>
                <p>O Controle Financeiro oferece ao usuário ferramentas para controle e gestão financeira, permitindo o registro de receitas, despesas, metas e outras informações relacionadas. O serviço é oferecido “como está”, podendo ser atualizado ou alterado a qualquer momento.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">3. Cadastro do Usuário</h3>
                <p>Para utilizar o sistema, o usuário deve fornecer informações verdadeiras e completas no formulário de cadastro. O usuário é responsável por manter seus dados de acesso (login e senha) seguros e não compartilhá-los com terceiros. É proibido criar contas falsas ou utilizar informações de terceiros sem autorização.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">4. Uso da Plataforma</h3>
                <p>É vedado ao usuário: Utilizar o sistema para fins ilícitos ou fraudulentos; Tentar obter acesso não autorizado a áreas restritas do sistema; Distribuir, copiar ou revender o sistema sem autorização. O uso indevido poderá resultar no bloqueio ou exclusão da conta, sem prejuízo das medidas legais cabíveis.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">5. Dados e Privacidade</h3>
                <p>Todas as informações inseridas no sistema são de propriedade do usuário, mas o Controle Financeiro poderá processá-las e armazená-las para funcionamento do serviço. Os dados são protegidos conforme nossa Política de Privacidade e pela legislação aplicável, incluindo a Lei Geral de Proteção de Dados (LGPD – Lei nº 13.709/2018). O usuário é responsável pelo conteúdo cadastrado, devendo garantir que não infringe direitos de terceiros.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">6. Responsabilidade</h3>
                <p>O Controle Financeiro: Não se responsabiliza por erros ou perdas causadas por informações incorretas inseridas pelo usuário; Não garante disponibilidade contínua do serviço, podendo realizar manutenções ou interrupções programadas; Não se responsabiliza por prejuízos financeiros decorrentes de má gestão ou decisões tomadas com base nos dados inseridos no sistema.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">7. Segurança</h3>
                <p>O usuário deve manter seu dispositivo seguro e atualizado; É recomendada a ativação da autenticação em dois fatores (2FA); Qualquer suspeita de acesso não autorizado deve ser comunicada imediatamente à equipe de suporte.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">8. Cancelamento e Exclusão de Conta</h3>
                <p>O usuário pode solicitar a exclusão de sua conta a qualquer momento; A exclusão remove os dados de forma irreversível, conforme prazos da nossa Política de Privacidade; Em caso de violação destes termos, a conta poderá ser suspensa ou encerrada sem aviso prévio.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">9. Alterações dos Termos</h3>
                <p>O Controle Financeiro poderá modificar estes Termos a qualquer momento. Alterações relevantes serão comunicadas por e-mail ou dentro da plataforma.</p>
                <h3 class="font-semibold text-zinc-800 dark:text-zinc-100">10. Foro e Legislação Aplicável</h3>
                <p>Estes Termos serão regidos pela legislação brasileira. Fica eleito o foro da comarca de Macapá/AP como competente para dirimir quaisquer disputas, com renúncia expressa de qualquer outro.</p>
                <p class="mt-4 text-sm"><strong>Última atualização:</strong> 08 de Agosto de 2025</p>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div id="app-container">

        <!-- Tela de Login/Registro -->
        <div id="auth-view">
            <div class="flex flex-col items-center justify-center min-h-screen p-4">
                <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-zinc-800 rounded-2xl shadow-lg">
                    <div class="text-center">
                         <svg class="mx-auto h-10 w-auto text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 3a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m15-3V6a2.25 2.25 0 00-2.25-2.25H8.25A2.25 2.25 0 006 6v3m12 6v3a2.25 2.25 0 01-2.25 2.25H8.25a2.25 2.25 0 01-2.25-2.25v-3" />
                        </svg>
                        <h1 class="text-3xl font-bold mt-4 text-zinc-900 dark:text-white">Controle Financeiro</h1>
                    </div>

                    <!-- Formulário de Login -->
                    <div id="login-container">
                        <h2 class="text-xl font-semibold text-center mb-4 text-zinc-700 dark:text-zinc-300">Acesse a sua conta</h2>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <label for="login-email" class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Email</label>
                                <input type="email" id="login-email" required class="w-full px-4 py-2 mt-1 text-zinc-800 bg-zinc-100 dark:bg-zinc-700 dark:text-zinc-200 border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="login-password" class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Senha</label>
                                <input type="password" id="login-password" required class="w-full px-4 py-2 mt-1 text-zinc-800 bg-zinc-100 dark:bg-zinc-700 dark:text-zinc-200 border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <button type="submit" class="w-full py-3 font-semibold text-white bg-sky-500 rounded-md hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-300">Entrar</button>
                        </form>
                        <p class="mt-6 text-center text-sm text-zinc-500 dark:text-zinc-400">
                            Não tem uma conta?
                            <a href="#" id="show-register-link" class="font-medium text-sky-500 hover:text-sky-400">Registe-se</a>
                        </p>
                    </div>

                    <!-- Formulário de Registro (escondido) -->
                    <div id="register-container" class="hidden">
                        <h2 class="text-xl font-semibold text-center mb-4 text-zinc-700 dark:text-zinc-300">Crie a sua conta</h2>
                        <form id="register-form" class="space-y-4">
                             <div>
                                <label for="register-name" class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Nome Completo</label>
                                <input type="text" id="register-name" required class="w-full px-4 py-2 mt-1 text-zinc-800 bg-zinc-100 dark:bg-zinc-700 dark:text-zinc-200 border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="register-email" class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Email</label>
                                <input type="email" id="register-email" required class="w-full px-4 py-2 mt-1 text-zinc-800 bg-zinc-100 dark:bg-zinc-700 dark:text-zinc-200 border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="register-password" class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Senha</label>
                                <input type="password" id="register-password" required class="w-full px-4 py-2 mt-1 text-zinc-800 bg-zinc-100 dark:bg-zinc-700 dark:text-zinc-200 border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div>
                                <label for="register-password-confirm" class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Confirme a Senha</label>
                                <input type="password" id="register-password-confirm" required class="w-full px-4 py-2 mt-1 text-zinc-800 bg-zinc-100 dark:bg-zinc-700 dark:text-zinc-200 border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                             <div class="flex items-center">
                                <input id="register-terms" type="checkbox" required class="h-4 w-4 rounded border-zinc-300 text-sky-600 focus:ring-sky-500">
                                <label for="register-terms" class="ml-2 block text-sm text-zinc-600 dark:text-zinc-400">Eu aceito os <a href="#" id="open-terms-link" class="font-medium text-sky-500 hover:text-sky-400">Termos de Uso</a></label>
                            </div>
                            <button type="submit" class="w-full py-3 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300">Registar</button>
                        </form>
                        <p class="mt-6 text-center text-sm text-zinc-500 dark:text-zinc-400">
                            Já tem uma conta?
                            <a href="#" id="show-login-link" class="font-medium text-sky-500 hover:text-sky-400">Faça login</a>
                        </p>
                    </div>
                    <p id="auth-error" class="text-center text-red-500 text-sm h-4 mt-2"></p>
                </div>
            </div>
        </div>

        <!-- Layout Principal da Aplicação (escondido por padrão) -->
        <div id="main-layout" class="hidden">
            <div class="p-4 md:p-8">
                <header class="flex flex-wrap items-center justify-between mb-8 pb-4 border-b border-zinc-200 dark:border-zinc-700">
                    <div>
                        <h1 class="text-3xl font-bold text-zinc-900 dark:text-white">Dashboard</h1>
                        <p id="user-info" class="text-zinc-500 dark:text-zinc-400">Bem-vindo(a), <span id="user-name" class="font-medium"></span></p>
                    </div>
                    <div class="flex items-center space-x-4 mt-4 md:mt-0">
                         <button id="logout-button-main" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Sair</button>
                    </div>
                </header>

                <!-- Filtros de Período -->
                <div class="mb-6">
                    <div id="period-filter" class="flex items-center space-x-2 bg-zinc-200 dark:bg-zinc-800 p-1 rounded-lg max-w-xs">
                        <button data-period="day" class="filter-btn w-full px-4 py-1.5 text-sm font-semibold text-zinc-600 dark:text-zinc-300 rounded-md transition-colors">Dia</button>
                        <button data-period="month" class="filter-btn w-full px-4 py-1.5 text-sm font-semibold text-zinc-600 dark:text-zinc-300 rounded-md transition-colors active bg-white dark:bg-zinc-700 text-sky-500 shadow-sm">Mês</button>
                        <button data-period="year" class="filter-btn w-full px-4 py-1.5 text-sm font-semibold text-zinc-600 dark:text-zinc-300 rounded-md transition-colors">Ano</button>
                    </div>
                </div>

                <!-- Cards de Resumo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold text-zinc-500 dark:text-zinc-400">Receitas</h3>
                        <p id="income-total" class="text-3xl font-bold text-green-500">R$ 0,00</p>
                    </div>
                    <div class="p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold text-zinc-500 dark:text-zinc-400">Despesas</h3>
                        <p id="expense-total" class="text-3xl font-bold text-red-500">R$ 0,00</p>
                    </div>
                    <div class="p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold text-zinc-500 dark:text-zinc-400">Saldo do Período</h3>
                        <p id="balance-total" class="text-3xl font-bold text-sky-500">R$ 0,00</p>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4">Receitas por Categoria</h3>
                        <div class="chart-container">
                            <canvas id="income-chart"></canvas>
                        </div>
                    </div>
                    <div class="p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold mb-4">Despesas por Categoria</h3>
                        <div class="chart-container">
                            <canvas id="expense-chart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        const { createClient } = supabase;

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO DO SUPABASE ---
        const SUPABASE_URL = 'https://sxkxsgftbtzzinswywer.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4a3hzZ2Z0YnR6emluc3d5d2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTc0MDYsImV4cCI6MjA2OTk5MzQwNn0.-O5fd9Vc2ylnQRxX2H0J1oYl3EzNgegGlLtfpaBeYOw';

        // --- REFERÊNCIAS DO DOM ---
        const authView = document.getElementById('auth-view');
        const mainLayout = document.getElementById('main-layout');
        const loginContainer = document.getElementById('login-container');
        const registerContainer = document.getElementById('register-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const authError = document.getElementById('auth-error');
        const logoutButtonMain = document.getElementById('logout-button-main');
        const termsModal = document.getElementById('terms-modal');
        const openTermsLink = document.getElementById('open-terms-link');
        const closeTermsModal = document.getElementById('close-terms-modal');
        const userNameEl = document.getElementById('user-name');
        const periodFilter = document.getElementById('period-filter');
        const incomeTotalEl = document.getElementById('income-total');
        const expenseTotalEl = document.getElementById('expense-total');
        const balanceTotalEl = document.getElementById('balance-total');
        const incomeChartCanvas = document.getElementById('income-chart');
        const expenseChartCanvas = document.getElementById('expense-chart');

        // VERIFICAÇÃO DE CONFIGURAÇÃO
        if (SUPABASE_ANON_KEY === 'SUA_CHAVE_AQUI') {
            authView.innerHTML = `<div class="p-8 text-center text-red-500">Erro: A chave de API do Supabase não foi configurada no ficheiro index.html.</div>`;
            throw new Error("Supabase não configurado.");
        }

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let allTransactions = [];
        let userCategories = [];
        let incomeChart = null;
        let expenseChart = null;
        let currentPeriod = 'month';

        // --- LÓGICA DO MODAL DE TERMOS ---
        if (openTermsLink) {
            openTermsLink.addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.classList.remove('hidden');
                setTimeout(() => termsModal.classList.remove('opacity-0'), 10);
            });
        }
        if (closeTermsModal) {
            closeTermsModal.addEventListener('click', () => {
                termsModal.classList.add('opacity-0');
                setTimeout(() => termsModal.classList.add('hidden'), 300);
            });
        }


        // --- AUTENTICAÇÃO E UI ---
        if (showRegisterLink) {
            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginContainer.classList.add('hidden');
                registerContainer.classList.remove('hidden');
                authError.textContent = '';
            });
        }

        if (showLoginLink) {
            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                authError.textContent = '';
            });
        }
        
        // Observador do estado de autenticação
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (session && session.user) {
                currentUser = session.user;
                authView.classList.add('hidden');
                mainLayout.classList.remove('hidden');
                await loadInitialData();
            } else {
                currentUser = null;
                mainLayout.classList.add('hidden');
                authView.classList.remove('hidden');
            }
        });

        // Formulário de Registro
        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullName = registerForm['register-name'].value;
                const email = registerForm['register-email'].value;
                const password = registerForm['register-password'].value;
                const passwordConfirm = registerForm['register-password-confirm'].value;
                const termsAccepted = registerForm['register-terms'].checked;
                authError.textContent = '';

                if (password !== passwordConfirm) {
                    authError.textContent = 'As senhas não coincidem.';
                    return;
                }
                if (password.length < 8) {
                    authError.textContent = 'A senha deve ter pelo menos 8 caracteres.';
                    return;
                }
                if (!termsAccepted) {
                    authError.textContent = 'Você precisa de aceitar os Termos de Uso.';
                    return;
                }

                const { data, error } = await supabaseClient.auth.signUp({ 
                    email, 
                    password
                });

                if (error) {
                    authError.textContent = 'Erro no registo: ' + error.message;
                } else if (data.user) {
                    // Atualiza o perfil com o nome completo
                    const { error: profileError } = await supabaseClient
                        .from('profiles')
                        .update({ full_name: fullName })
                        .eq('id', data.user.id);

                    if (profileError) {
                        authError.textContent = 'Erro ao guardar o nome do utilizador.';
                    } else {
                        authError.textContent = 'Registo realizado! Verifique o seu e-mail para confirmação.';
                        registerForm.reset();
                    }
                }
            });
        }

        // Formulário de Login
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm['login-email'].value;
                const password = loginForm['login-password'].value;
                authError.textContent = '';

                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (error) {
                    authError.textContent = 'E-mail ou senha inválidos.';
                }
            });
        }

        // Logout
        if (logoutButtonMain) {
            logoutButtonMain.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
            });
        }

        // --- LÓGICA DO DASHBOARD ---

        async function loadInitialData() {
            if (!currentUser) return;
            
            const { data: profile } = await supabaseClient.from('profiles').select('full_name').eq('id', currentUser.id).single();
            if (userNameEl) {
                userNameEl.textContent = profile?.full_name || currentUser.email;
            }

            const { data: categories } = await supabaseClient.from('categories').select('*');
            userCategories = categories || [];

            const { data: transactions } = await supabaseClient.from('transactions').select('*');
            allTransactions = transactions || [];

            updateDashboard();
        }

        function filterTransactionsByPeriod(period) {
            const now = new Date();
            let startDate;

            if (period === 'day') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (period === 'year') {
                startDate = new Date(now.getFullYear(), 0, 1);
            }
            
            return allTransactions.filter(tx => new Date(tx.date) >= startDate);
        }

        function updateDashboard() {
            const filteredTransactions = filterTransactionsByPeriod(currentPeriod);
            
            let income = 0;
            let expense = 0;
            const incomeByCategory = {};
            const expenseByCategory = {};

            filteredTransactions.forEach(tx => {
                const category = userCategories.find(c => c.id === tx.category_id)?.name || 'Sem Categoria';
                if (tx.amount > 0) {
                    income += tx.amount;
                    incomeByCategory[category] = (incomeByCategory[category] || 0) + tx.amount;
                } else {
                    expense += Math.abs(tx.amount);
                    expenseByCategory[category] = (expenseByCategory[category] || 0) + Math.abs(tx.amount);
                }
            });

            if (incomeTotalEl) incomeTotalEl.textContent = formatCurrency(income);
            if (expenseTotalEl) expenseTotalEl.textContent = formatCurrency(expense);
            if (balanceTotalEl) balanceTotalEl.textContent = formatCurrency(income - expense);

            renderPieChart(incomeChart, incomeChartCanvas, 'Receitas', incomeByCategory);
            renderPieChart(expenseChart, expenseChartCanvas, 'Despesas', expenseByCategory);
        }
        
        function renderPieChart(chartInstance, canvas, label, data) {
            if (!canvas) return;
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            const chartColors = label === 'Receitas' 
                ? ['#16a34a', '#4ade80', '#86efac', '#dcfce7']
                : ['#dc2626', '#f87171', '#fca5a5', '#fee2e2'];

            chartInstance = new Chart(canvas.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: values,
                        backgroundColor: chartColors,
                        borderColor: document.documentElement.classList.contains('dark') ? '#18181b' : '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#a1a1aa' : '#52525b'
                            }
                        }
                    }
                }
            });
            if (label === 'Receitas') incomeChart = chartInstance;
            else expenseChart = chartInstance;
        }

        if (periodFilter) {
            periodFilter.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentPeriod = e.target.dataset.period;
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-white', 'dark:bg-zinc-700', 'text-sky-500', 'shadow-sm');
                    });
                    e.target.classList.add('active', 'bg-white', 'dark:bg-zinc-700', 'text-sky-500', 'shadow-sm');
                    updateDashboard();
                }
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

    </script>
</body>
</html>
