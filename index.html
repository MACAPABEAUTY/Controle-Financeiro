<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Financeiro - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        .sidebar-link.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Estilos Dark Mode */
        .dark .bg-gray-100 { background-color: #111827; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .text-gray-800 { color: #d1d5db; }
        .dark .text-gray-900 { color: #f9fafb; }
        .dark .text-gray-700 { color: #9ca3af; }
        .dark .text-gray-600 { color: #6b7280; }
        .dark .text-gray-500 { color: #6b7280; }
        .dark .border-gray-300 { border-color: #4b5563; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2); }
        .dark .hover\:bg-gray-200:hover { background-color: #374151; }
        .dark .sidebar-link.active { background-color: #4338ca; }
        .dark .bg-indigo-50 { background-color: #3730a3; }
        .dark .text-indigo-600 { color: #a5b4fc; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" name="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="login-password" name="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <p id="login-error-message" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Entrar</button>
            </form>
            <p class="text-center text-sm text-gray-600 mt-4">
                Não tem uma conta? <a href="#" id="show-register-link" class="font-medium text-blue-600 hover:text-blue-500">Cadastre-se</a>
            </p>
        </div>
    </div>

    <!-- Tela de Cadastro -->
    <div id="registration-screen" class="min-h-screen flex items-center justify-center hidden py-12">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-lg">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">Crie sua Conta</h2>
            <form id="registration-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div class="md:col-span-2"><label for="reg-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="reg-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div class="md:col-span-2"><label for="reg-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="reg-email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div><label for="reg-password" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="reg-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div><label for="reg-password-confirm" class="block text-sm font-medium text-gray-700">Confirmar Senha</label><input type="password" id="reg-password-confirm" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                <div><label for="reg-dob" class="block text-sm font-medium text-gray-700">Data de Nascimento</label><input type="date" id="reg-dob" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><label for="reg-income" class="block text-sm font-medium text-gray-700">Renda Mensal (R$)</label><input type="number" id="reg-income" placeholder="3000.00" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div class="md:col-span-2"><label for="reg-goals" class="block text-sm font-medium text-gray-700">Principais Objetivos Financeiros</label><textarea id="reg-goals" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Comprar um imóvel, fazer uma viagem, quitar dívidas..."></textarea></div>
                <p id="register-error-message" class="text-red-500 text-sm text-center md:col-span-2 hidden"></p>
                <div class="md:col-span-2 mt-4"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Cadastrar</button></div>
            </form>
            <p class="text-center text-sm text-gray-600 mt-4">Já tem uma conta? <a href="#" id="show-login-link" class="font-medium text-blue-600 hover:text-blue-500">Faça o login</a></p>
        </div>
    </div>

    <!-- Tela Principal da Aplicação -->
    <div id="app-screen" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Menu Lateral -->
            <nav class="w-64 bg-white shadow-lg flex flex-col">
                <div>
                    <div class="p-6">
                        <h1 class="text-2xl font-bold text-indigo-600">Meu App</h1>
                    </div>
                    <ul class="mt-6">
                        <li><a href="#" data-target="dashboard-content" class="sidebar-link active flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> Dashboard</a></li>
                        <li><a href="#" data-target="accounts-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg> Contas</a></li>
                        <li><a href="#" data-target="credit-cards-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg> Cartões de Crédito</a></li>
                        <li><a href="#" data-target="transactions-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Transações</a></li>
                        <li><a href="#" data-target="contracts-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 14h.01M7 17h5a2 2 0 012 2v1a2 2 0 01-2 2H7a2 2 0 01-2-2v-1a2 2 0 012-2zm10-4h.01M17 13h1a2 2 0 012 2v5a2 2 0 01-2 2h-1a2 2 0 01-2-2v-5a2 2 0 012-2zM7 7h.01"></path></svg> Contratos</a></li>
                        <li><a href="#" data-target="planning-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg> Planejamento</a></li>
                        <li><a href="#" data-target="reports-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Relatórios</a></li>
                        <li><a href="#" data-target="goals-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg> Metas</a></li>
                        <li><a href="#" data-target="categories-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg> Categorias</a></li>
                        <li><a href="#" data-target="settings-content" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> Configurações</a></li>
                    </ul>
                </div>
                <div class="mt-auto p-6">
                    <a href="#" id="logout-button" class="flex items-center px-6 py-3 text-gray-700 hover:bg-red-100 hover:text-red-600 rounded-lg transition-colors">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Sair
                    </a>
                </div>
            </nav>

            <!-- Conteúdo Principal -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                    
                    <!-- Seção Dashboard -->
                    <div id="dashboard-content" class="app-content">
                        <div id="summary-dashboard" class="mb-8">
                            <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Saldo atual</p><p id="summary-balance" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div><div class="bg-blue-100 text-blue-600 rounded-full p-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg></div></div>
                                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Receitas</p><p id="summary-income" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div><div class="bg-green-100 text-green-600 rounded-full p-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path></svg></div></div>
                                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Despesas</p><p id="summary-expenses" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div><div class="bg-red-100 text-red-600 rounded-full p-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg></div></div>
                                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Cartão de crédito</p><p id="summary-credit-card" class="text-2xl font-bold text-gray-800">R$ 0,00</p></div><div class="bg-indigo-100 text-indigo-600 rounded-full p-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg></div></div>
                            </div>
                        </div>
                        <div id="charts-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold text-center mb-2">Despesas por Categoria</h3><div class="h-64 flex items-center justify-center"><canvas id="expense-chart"></canvas><p id="no-expense-data" class="text-gray-500 text-center">Nenhuma despesa categorizada.</p></div></div>
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold text-center mb-2">Receitas por Categoria</h3><div class="h-64 flex items-center justify-center"><canvas id="income-chart"></canvas><p id="no-income-data" class="text-gray-500 text-center">Nenhuma receita categorizada.</p></div></div>
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-semibold text-center mb-2">Balanço do Período</h3><div class="h-64 flex items-center justify-center"><canvas id="balance-chart"></canvas><p id="no-balance-data" class="text-gray-500 text-center">Sem dados para o balanço.</p></div></div>
                        </div>
                    </div>

                    <!-- Seção Contas -->
                    <div id="accounts-content" class="app-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Minhas Contas</h2>
                                <button id="add-account-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Adicionar Nova Conta</button>
                            </div>
                            <div id="accounts-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <p id="no-accounts-message" class="text-gray-500 md:col-span-2 lg:col-span-3 text-center py-4">Nenhuma conta cadastrada ainda.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Seção Cartões de Crédito -->
                    <div id="credit-cards-content" class="app-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Meus Cartões de Crédito</h2>
                                <button id="add-credit-card-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Novo Cartão de Crédito</button>
                            </div>
                            <div id="credit-cards-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <p id="no-credit-cards-message" class="text-gray-500 md:col-span-2 lg:col-span-3 text-center py-4">Nenhum cartão de crédito cadastrado.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Seção Transações -->
                    <div id="transactions-content" class="app-content hidden">
                        <div id="upload-section" class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <h2 class="text-xl font-semibold mb-4">Importar Extrato OFX</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                                <div><label for="account-select-for-upload" class="block text-sm font-medium text-gray-700 mb-1">Selecione a conta para importar o extrato:</label><select id="account-select-for-upload" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select></div>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"><input type="file" id="ofx-file-input" accept=".ofx,.xml" class="hidden"><button id="upload-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400" disabled>Selecionar Arquivo OFX</button><p id="file-name" class="mt-2 text-gray-500 text-sm">Nenhum arquivo selecionado.</p></div>
                            </div>
                        </div>
                        <div id="transactions-section" class="bg-white rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Suas Transações</h2>
                                <div class="flex items-center gap-4">
                                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                                    <span id="month-display" class="text-lg font-semibold text-indigo-600"></span>
                                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                                </div>
                                <div class="flex items-center"><label for="hide-categorized-toggle" class="text-sm font-medium text-gray-700 mr-2">Ocultar categorizadas</label><input type="checkbox" id="hide-categorized-toggle" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
                            </div>
                            <div id="loading-spinner" class="hidden flex justify-center items-center py-8"><div class="loader"></div></div>
                            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4" role="alert"><strong class="font-bold">Erro!</strong><span class="block sm:inline" id="error-text"></span></div>
                            <div id="transactions-container" class="overflow-x-auto">
                                <p id="no-transactions" class="text-gray-500 text-center py-8">Nenhuma transação importada ainda.</p>
                                <table id="transactions-table" class="min-w-full hidden"><thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th><th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th></tr></thead><tbody id="transactions-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                            </div>
                            <div id="pagination-controls" class="hidden flex justify-between items-center mt-4"><button id="prev-page-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button><span id="page-info" class="text-sm font-medium"></span><button id="next-page-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">Próxima</button></div>
                        </div>
                    </div>

                    <!-- Seção Contratos -->
                    <div id="contracts-content" class="app-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Meus Contratos</h2>
                                <div>
                                    <button id="manage-clients-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors mr-2">Gerenciar Clientes</button>
                                    <button id="add-contract-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Novo Contrato</button>
                                </div>
                            </div>
                            <div id="contracts-list" class="space-y-4">
                                <p id="no-contracts-message" class="text-gray-500 text-center py-4">Nenhum contrato cadastrado.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Seção Planejamento -->
                    <div id="planning-content" class="app-content hidden">
                         <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <h2 class="text-2xl font-semibold mb-6">Planejamento Mensal</h2>
                            <form id="planning-form">
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <!-- Coluna de Categorias -->
                                    <div class="lg:col-span-1 bg-gray-50 p-4 rounded-lg">
                                        <h3 class="font-semibold mb-4">Hora de planejar!</h3>
                                        <p class="text-sm text-gray-600 mb-4">Preencha os campos abaixo com seus limites de gastos para cada categoria.</p>
                                        <div id="planning-category-list" class="space-y-4 max-h-96 overflow-y-auto">
                                            <!-- Categorias serão inseridas aqui -->
                                        </div>
                                    </div>
                                    <!-- Coluna de Resumo -->
                                    <div class="lg:col-span-2">
                                        <div class="bg-gray-50 p-6 rounded-lg mb-6">
                                            <h3 class="font-semibold mb-2">Renda Mensal</h3>
                                            <input type="number" id="monthly-income" step="0.01" class="block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Quanto você ganha por mês?">
                                        </div>
                                        <div class="bg-white p-6 rounded-lg shadow-inner">
                                            <div class="h-48 w-48 mx-auto mb-4">
                                                <canvas id="planning-chart"></canvas>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-gray-600">Total Planejado</p>
                                                <p id="planning-total-planned" class="text-2xl font-bold">R$ 0,00</p>
                                                <p class="text-gray-500 text-sm mt-1">de <span id="planning-budget-total">R$ 0,00</span></p>
                                            </div>
                                        </div>
                                        <button type="submit" class="mt-6 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Salvar Planejamento</button>
                                        <p id="planning-success-message" class="text-green-600 text-center mt-2 hidden">Planejamento salvo com sucesso!</p>
                                    </div>
                                </div>
                            </form>
                         </div>
                    </div>

                    <!-- Seção Relatórios -->
                    <div id="reports-content" class="app-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-semibold">Relatório de Despesas</h2>
                                <div class="flex items-center gap-4">
                                    <button id="prev-report-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                                    <span id="report-month-display" class="text-lg font-semibold text-indigo-600"></span>
                                    <button id="next-report-month-btn" class="p-2 rounded-full hover:bg-gray-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2">
                                    <div id="report-category-list">
                                        <!-- Lista de categorias do relatório será inserida aqui -->
                                    </div>
                                </div>
                                <div class="lg:col-span-1">
                                    <div class="bg-white p-6 rounded-lg shadow-inner">
                                        <div class="h-48 w-48 mx-auto mb-4">
                                            <canvas id="report-chart"></canvas>
                                            <p id="no-report-data" class="text-gray-500 text-center hidden">Sem dados para este mês.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção Metas -->
                    <div id="goals-content" class="app-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Minhas Metas</h2>
                                <button id="add-goal-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Adicionar Nova Meta</button>
                            </div>
                            <div id="goals-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <p id="no-goals-message" class="text-gray-500 md:col-span-2 lg:col-span-3 text-center py-4">Nenhuma meta cadastrada ainda.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Seção Configurações -->
                    <div id="settings-content" class="app-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-8 max-w-2xl mx-auto">
                            <h2 class="text-2xl font-semibold mb-6">Configurações</h2>
                            <form id="settings-form">
                                <div class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="setting-language" class="block text-sm font-medium text-gray-700">Idioma</label>
                                            <select id="setting-language" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                                <option>Português Brasil</option>
                                                <option>English</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="setting-currency" class="block text-sm font-medium text-gray-700">Moeda</label>
                                            <select id="setting-currency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                                <option>BRL (R$)</option>
                                                <option>USD ($)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="setting-appearance" class="block text-sm font-medium text-gray-700">Aparência</label>
                                        <select id="setting-appearance" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="light">Modo claro</option>
                                            <option value="dark">Modo escuro</option>
                                        </select>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
                                    </div>
                                    <p id="settings-success-message" class="text-green-600 text-center mt-2 hidden">Configurações salvas com sucesso!</p>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Seção Categorias -->
                    <div id="categories-content" class="app-content hidden">
                        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Gerenciar Categorias</h2>
                                <button id="add-category-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Adicionar Categoria</button>
                            </div>
                            <div id="categories-list" class="space-y-2">
                                <!-- Lista de categorias será inserida aqui -->
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- Modal Adicionar Conta -->
    <div id="account-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-md p-6 rounded-lg shadow-xl transform scale-95">
            <!-- Passo 1: Seleção de Banco -->
            <div id="modal-step-1">
                <h2 class="text-2xl font-bold mb-4">Qual instituição você quer adicionar?</h2>
                <input type="text" id="bank-search" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4" placeholder="Buscar por nome...">
                <div id="bank-list" class="max-h-64 overflow-y-auto">
                    <!-- Lista de bancos será inserida aqui -->
                </div>
                 <div class="flex justify-end mt-4">
                    <button type="button" id="cancel-account-btn-step1" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                </div>
            </div>
            <!-- Passo 2: Detalhes da Conta -->
            <div id="modal-step-2" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-step1-btn" class="p-2 rounded-full hover:bg-gray-200 mr-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                    <h2 class="text-2xl font-bold">Adicionar Nova Conta</h2>
                </div>
                <form id="add-account-form">
                    <div class="mb-4"><label for="account-bank" class="block text-sm font-medium text-gray-700">Instituição</label><input type="text" id="account-bank" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly></div>
                    <div class="mb-4"><label for="account-name" class="block text-sm font-medium text-gray-700">Nome da Conta</label><input type="text" id="account-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: Conta Corrente Principal" required></div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label for="account-agency" class="block text-sm font-medium text-gray-700">Agência</label><input type="text" id="account-agency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: 0001"></div>
                        <div><label for="account-number" class="block text-sm font-medium text-gray-700">Conta</label><input type="text" id="account-number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: 12345-6"></div>
                    </div>
                    <div class="mb-4"><label for="account-type" class="block text-sm font-medium text-gray-700">Tipo de Conta</label><select id="account-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"><option>Conta Corrente</option><option>Poupança</option><option>Investimentos</option><option>Carteira</option><option>Outro</option></select></div>
                    <div class="mb-6"><label for="account-balance" class="block text-sm font-medium text-gray-700">Saldo Inicial (R$)</label><input type="number" id="account-balance" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="1000.00" required></div>
                    <div class="flex justify-end gap-4"><button type="button" id="cancel-account-btn-step2" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar Conta</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Cartão de Crédito -->
    <div id="credit-card-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-md p-6 rounded-lg shadow-xl transform scale-95">
            <h2 class="text-2xl font-bold mb-4">Novo Cartão de Crédito</h2>
            <form id="add-credit-card-form">
                <div class="mb-4"><label for="cc-limit" class="block text-sm font-medium text-gray-700">Limite</label><input type="number" id="cc-limit" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="5000.00" required></div>
                <div class="mb-4"><label for="cc-description" class="block text-sm font-medium text-gray-700">Descrição</label><input type="text" id="cc-description" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: Nubank Ultravioleta" required></div>
                <div class="mb-4"><label for="cc-brand" class="block text-sm font-medium text-gray-700">Bandeira</label><select id="cc-brand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"><option>Visa</option><option>Mastercard</option><option>Elo</option><option>American Express</option><option>Outra</option></select></div>
                <div class="mb-4"><label for="cc-account-link" class="block text-sm font-medium text-gray-700">Conta Associada</label><select id="cc-account-link" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></select></div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label for="cc-close-day" class="block text-sm font-medium text-gray-700">Dia de Fechamento</label><input type="number" id="cc-close-day" min="1" max="31" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: 25" required></div>
                    <div><label for="cc-due-day" class="block text-sm font-medium text-gray-700">Dia de Vencimento</label><input type="number" id="cc-due-day" min="1" max="31" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: 5" required></div>
                </div>
                <div class="flex justify-end gap-4"><button type="button" id="cancel-cc-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar Cartão</button></div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar Meta -->
    <div id="goal-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-md p-6 rounded-lg shadow-xl transform scale-95">
            <h2 class="text-2xl font-bold mb-4">Adicionar Nova Meta</h2>
            <form id="add-goal-form">
                <div class="mb-4"><label for="goal-name" class="block text-sm font-medium text-gray-700">Nome da Meta</label><input type="text" id="goal-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: Viagem para a Europa" required></div>
                <div class="mb-4"><label for="goal-target" class="block text-sm font-medium text-gray-700">Valor Alvo (R$)</label><input type="number" id="goal-target" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="15000.00" required></div>
                <div class="mb-6"><label for="goal-current" class="block text-sm font-medium text-gray-700">Valor Inicial Guardado (R$)</label><input type="number" id="goal-current" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="1000.00" required></div>
                <div class="flex justify-end gap-4"><button type="button" id="cancel-goal-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar Meta</button></div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar Contrato -->
    <div id="contract-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-md p-6 rounded-lg shadow-xl transform scale-95">
            <h2 class="text-2xl font-bold mb-4">Novo Contrato de Comissão</h2>
            <form id="add-contract-form">
                <div class="mb-4"><label for="contract-client" class="block text-sm font-medium text-gray-700">Cliente</label><select id="contract-client" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></select></div>
                <div class="mb-4"><label for="contract-value" class="block text-sm font-medium text-gray-700">Valor Total do Contrato (R$)</label><input type="number" id="contract-value" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="10000.00" required></div>
                <div class="mb-4"><label for="contract-percentage" class="block text-sm font-medium text-gray-700">Sua Comissão (%)</label><input type="number" id="contract-percentage" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="10" required></div>
                <div class="mb-4"><label for="contract-installments" class="block text-sm font-medium text-gray-700">Nº de Parcelas</label><input type="number" id="contract-installments" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="12" required></div>
                <div class="mb-4"><label for="contract-start-date" class="block text-sm font-medium text-gray-700">Data da 1ª Parcela</label><input type="date" id="contract-start-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div class="mb-6"><label for="contract-account-link" class="block text-sm font-medium text-gray-700">Creditar na Conta</label><select id="contract-account-link" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></select></div>
                <div class="flex justify-end gap-4"><button type="button" id="cancel-contract-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar Contrato</button></div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes do Contrato -->
    <div id="contract-details-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-2xl p-6 rounded-lg shadow-xl transform scale-95">
            <h2 id="contract-details-title" class="text-2xl font-bold mb-4">Detalhes do Contrato</h2>
            <div id="installments-list" class="max-h-96 overflow-y-auto">
                <!-- Lista de parcelas será inserida aqui -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" id="close-contract-details-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gerenciar Clientes -->
    <div id="clients-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-2xl p-6 rounded-lg shadow-xl transform scale-95">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Clientes</h2>
            <form id="add-client-form" class="p-4 border rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="client-cpf-cnpj" class="block text-sm font-medium text-gray-700">CPF/CNPJ</label>
                        <div class="flex items-center">
                            <input type="text" id="client-cpf-cnpj" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Digite o CNPJ para buscar">
                            <div id="cnpj-loader" class="loader ml-2 hidden" style="width: 20px; height: 20px;"></div>
                        </div>
                         <p id="cnpj-error" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    <div><label for="client-name" class="block text-sm font-medium text-gray-700">Nome do Cliente / Fantasia</label><input type="text" id="client-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div class="md:col-span-2"><label for="client-razao-social" class="block text-sm font-medium text-gray-700">Razão Social</label><input type="text" id="client-razao-social" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly></div>
                    <div class="md:col-span-2"><label for="client-address" class="block text-sm font-medium text-gray-700">Endereço</label><input type="text" id="client-address" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly></div>
                </div>
                <button type="submit" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Cliente</button>
            </form>
            <div id="clients-list" class="max-h-64 overflow-y-auto">
                <!-- Lista de clientes será inserida aqui -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" id="close-clients-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Categoria -->
    <div id="category-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-md p-6 rounded-lg shadow-xl transform scale-95">
            <h2 id="category-modal-title" class="text-2xl font-bold mb-4">Adicionar Nova Categoria</h2>
            <form id="add-category-form">
                <input type="hidden" id="category-id">
                <div class="mb-4">
                    <label for="category-name" class="block text-sm font-medium text-gray-700">Nome</label>
                    <input type="text" id="category-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="category-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                    <select id="category-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="expense">Despesa</option>
                        <option value="income">Receita</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="category-color" class="block text-sm font-medium text-gray-700">Cor</label>
                    <input type="color" id="category-color" class="mt-1 block w-full h-10 px-1 py-1 border border-gray-300 rounded-md" value="#FF6384">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-category-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- Variáveis Globais e Constantes ---
        let expenseChart, incomeChart, balanceChart, planningChart, reportChart;
        let userAccounts = [];
        let userCreditCards = [];
        let userGoals = [];
        let userContracts = [];
        let userClients = [];
        let users = []; // Armazena os usuários cadastrados
        let monthlyPlan = { income: 0, categoryBudgets: {} };
        let currentAccountId = null;
        let currentPage = 1;
        let currentDisplayDate = new Date();
        const TRANSACTIONS_PER_PAGE = 50;

        let CATEGORIES = [
            { id: 1, name: 'Moradia', type: 'expense', color: '#FF6384' },
            { id: 2, name: 'Alimentação', type: 'expense', color: '#FF9F40' },
            { id: 3, name: 'Transporte', type: 'expense', color: '#FFCD56' },
            { id: 4, name: 'Saúde', type: 'expense', color: '#4BC0C0' },
            { id: 5, name: 'Lazer', type: 'expense', color: '#9966FF' },
            { id: 6, name: 'Educação', type: 'expense', color: '#C9CBCF' },
            { id: 7, name: 'Investimentos', type: 'expense', color: '#36A2EB' },
            { id: 8, name: 'Outras Despesas', type: 'expense', color: '#F7464A' },
            { id: 9, name: 'Salário', type: 'income', color: '#46BFBD' },
            { id: 10, name: 'Outras Receitas', type: 'income', color: '#5AD3D1' },
        ];
        
        const AUTO_CATEGORIZATION_MAP = {
            'Alimentação': ['IFOOD', 'RESTAURANTE', 'MERCADO', 'PADARIA', 'LANCHONETE', 'SUPERMERCADO', 'HIPERMERCADO'],
            'Transporte': ['UBER', '99', 'POSTO', 'GASOLINA', 'ESTACIONAMENTO', 'PASSAGEM AEREA', 'ONIBUS', 'METRO'],
            'Moradia': ['ALUGUEL', 'CONDOMINIO', 'ENERGIA', 'AGUA', 'INTERNET', 'TELEFONE'],
            'Saúde': ['FARMACIA', 'DROGARIA', 'HOSPITAL', 'PLANO DE SAUDE', 'CONSULTA MEDICA'],
            'Lazer': ['CINEMA', 'NETFLIX', 'SPOTIFY', 'SHOW', 'TEATRO', 'VIAGEM'],
            'Educação': ['ESCOLA', 'FACULDADE', 'CURSO', 'LIVRARIA'],
            'Salário': ['SALARIO', 'PAGAMENTO', 'VENCIMENTO', 'CREDITO SALARIO'],
        };
        let ALL_BANKS = [];

        // --- Gerenciamento de Telas e Modais ---
        const loginScreen = document.getElementById('login-screen');
        const registrationScreen = document.getElementById('registration-screen');
        const appScreen = document.getElementById('app-screen');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const logoutButton = document.getElementById('logout-button');
        const loginForm = document.getElementById('login-form');
        const registrationForm = document.getElementById('registration-form');
        const loginErrorMessage = document.getElementById('login-error-message');
        const registerErrorMessage = document.getElementById('register-error-message');
        
        const accountModal = document.getElementById('account-modal');
        const addAccountBtn = document.getElementById('add-account-btn');
        const cancelAccountBtnStep1 = document.getElementById('cancel-account-btn-step1');
        const cancelAccountBtnStep2 = document.getElementById('cancel-account-btn-step2');
        const addAccountForm = document.getElementById('add-account-form');
        const modalStep1 = document.getElementById('modal-step-1');
        const modalStep2 = document.getElementById('modal-step-2');
        const backToStep1Btn = document.getElementById('back-to-step1-btn');
        const bankSearchInput = document.getElementById('bank-search');
        const bankListEl = document.getElementById('bank-list');

        const creditCardModal = document.getElementById('credit-card-modal');
        const addCreditCardBtn = document.getElementById('add-credit-card-btn');
        const cancelCreditCardBtn = document.getElementById('cancel-cc-btn');
        const addCreditCardForm = document.getElementById('add-credit-card-form');
        const ccAccountLinkSelect = document.getElementById('cc-account-link');

        const goalModal = document.getElementById('goal-modal');
        const addGoalBtn = document.getElementById('add-goal-btn');
        const cancelGoalBtn = document.getElementById('cancel-goal-btn');
        const addGoalForm = document.getElementById('add-goal-form');

        const contractModal = document.getElementById('contract-modal');
        const addContractBtn = document.getElementById('add-contract-btn');
        const cancelContractBtn = document.getElementById('cancel-contract-btn');
        const addContractForm = document.getElementById('add-contract-form');
        const contractClientSelect = document.getElementById('contract-client');
        const contractAccountLinkSelect = document.getElementById('contract-account-link');
        const contractDetailsModal = document.getElementById('contract-details-modal');
        const closeContractDetailsBtn = document.getElementById('close-contract-details-btn');

        const clientsModal = document.getElementById('clients-modal');
        const manageClientsBtn = document.getElementById('manage-clients-btn');
        const closeClientsBtn = document.getElementById('close-clients-btn');
        const addClientForm = document.getElementById('add-client-form');
        const clientsListEl = document.getElementById('clients-list');
        const clientCpfCnpjInput = document.getElementById('client-cpf-cnpj');
        const cnpjLoader = document.getElementById('cnpj-loader');
        const cnpjError = document.getElementById('cnpj-error');

        const categoryModal = document.getElementById('category-modal');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const cancelCategoryBtn = document.getElementById('cancel-category-btn');
        const addCategoryForm = document.getElementById('add-category-form');

        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.app-content');

        function showScreen(screen) {
            loginScreen.classList.add('hidden');
            registrationScreen.classList.add('hidden');
            appScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        function showContent(targetId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');

            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.target === targetId) {
                    link.classList.add('active');
                }
            });

            if (targetId === 'reports-content') {
                updateReportView();
            }
        }

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showContent(e.currentTarget.dataset.target);
            });
        });

        const openModal = (modal) => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-container').classList.remove('scale-95');
            }, 10);
        };
        const closeModal = (modal) => {
             modal.classList.add('opacity-0');
             const modalContainer = modal.querySelector('.modal-container');
             if (modalContainer) {
                modalContainer.classList.add('scale-95');
             }
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(registrationScreen); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(loginScreen); });
        logoutButton.addEventListener('click', (e) => { e.preventDefault(); showScreen(loginScreen); });
        addAccountBtn.addEventListener('click', () => {
            modalStep1.classList.remove('hidden');
            modalStep2.classList.add('hidden');
            openModal(accountModal);
        });
        cancelAccountBtnStep1.addEventListener('click', () => closeModal(accountModal));
        cancelAccountBtnStep2.addEventListener('click', () => closeModal(accountModal));
        backToStep1Btn.addEventListener('click', () => {
            modalStep2.classList.add('hidden');
            modalStep1.classList.remove('hidden');
        });
        addCreditCardBtn.addEventListener('click', () => openModal(creditCardModal));
        cancelCreditCardBtn.addEventListener('click', () => closeModal(creditCardModal));
        addGoalBtn.addEventListener('click', () => openModal(goalModal));
        cancelGoalBtn.addEventListener('click', () => closeModal(goalModal));
        addContractBtn.addEventListener('click', () => openModal(contractModal));
        cancelContractBtn.addEventListener('click', () => closeModal(contractModal));
        manageClientsBtn.addEventListener('click', () => openModal(clientsModal));
        closeClientsBtn.addEventListener('click', () => closeModal(clientsModal));
        closeContractDetailsBtn.addEventListener('click', () => closeModal(contractDetailsModal));
        addCategoryBtn.addEventListener('click', () => openCategoryModal());
        cancelCategoryBtn.addEventListener('click', () => closeModal(categoryModal));

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const user = users.find(u => u.email === email);

            if (user && user.password === password) {
                loginErrorMessage.classList.add('hidden');
                showScreen(appScreen);
                showContent('dashboard-content');
                updateDashboard();
            } else {
                loginErrorMessage.textContent = "Email ou senha inválidos.";
                loginErrorMessage.classList.remove('hidden');
            }
        });
        registrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const passwordConfirm = document.getElementById('reg-password-confirm').value;

            if (password !== passwordConfirm) {
                registerErrorMessage.textContent = "As senhas não coincidem!";
                registerErrorMessage.classList.remove('hidden');
                return;
            }
            if (users.find(u => u.email === email)) {
                registerErrorMessage.textContent = "Este email já está cadastrado.";
                registerErrorMessage.classList.remove('hidden');
                return;
            }

            const newUser = {
                email: email,
                password: password,
                name: document.getElementById('reg-name').value,
            };
            users.push(newUser);
            registerErrorMessage.classList.add('hidden');
            alert("Cadastro realizado com sucesso!");
            showScreen(loginScreen);
        });

        // --- Lógica de Contas Bancárias e Cartões ---
        const accountsListEl = document.getElementById('accounts-list');
        const noAccountsMessage = document.getElementById('no-accounts-message');
        const accountSelectForUpload = document.getElementById('account-select-for-upload');
        const creditCardsListEl = document.getElementById('credit-cards-list');
        const noCreditCardsMessage = document.getElementById('no-credit-cards-message');
        const goalsListEl = document.getElementById('goals-list');
        const noGoalsMessage = document.getElementById('no-goals-message');
        const contractsListEl = document.getElementById('contracts-list');
        const noContractsMessage = document.getElementById('no-contracts-message');
        const categoriesListEl = document.getElementById('categories-list');

        addAccountForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newAccount = {
                id: Date.now(),
                name: document.getElementById('account-name').value,
                bank: document.getElementById('account-bank').value,
                agency: document.getElementById('account-agency').value,
                accountNumber: document.getElementById('account-number').value,
                type: document.getElementById('account-type').value,
                initialBalance: parseFloat(document.getElementById('account-balance').value),
                transactions: []
            };
            userAccounts.push(newAccount);
            renderAccounts();
            updateDashboard();
            addAccountForm.reset();
            closeModal(accountModal);
        });

        addCreditCardForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newCard = {
                id: Date.now(),
                limit: parseFloat(document.getElementById('cc-limit').value),
                description: document.getElementById('cc-description').value,
                brand: document.getElementById('cc-brand').value,
                linkedAccountId: parseInt(document.getElementById('cc-account-link').value),
                closeDay: parseInt(document.getElementById('cc-close-day').value),
                dueDay: parseInt(document.getElementById('cc-due-day').value),
            };
            userCreditCards.push(newCard);
            renderCreditCards();
            updateDashboard();
            addCreditCardForm.reset();
            closeModal(creditCardModal);
        });

        addGoalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newGoal = {
                id: Date.now(),
                name: document.getElementById('goal-name').value,
                targetAmount: parseFloat(document.getElementById('goal-target').value),
                currentAmount: parseFloat(document.getElementById('goal-current').value),
            };
            userGoals.push(newGoal);
            renderGoals();
            addGoalForm.reset();
            closeModal(goalModal);
        });

        addContractForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const totalValue = parseFloat(document.getElementById('contract-value').value);
            const percentage = parseFloat(document.getElementById('contract-percentage').value);
            const installmentsCount = parseInt(document.getElementById('contract-installments').value);
            const startDate = new Date(document.getElementById('contract-start-date').value + 'T00:00:00');

            const newContract = {
                id: Date.now(),
                clientId: parseInt(contractClientSelect.value),
                totalValue: totalValue,
                commissionPercentage: percentage,
                installmentsCount: installmentsCount,
                startDate: startDate,
                linkedAccountId: parseInt(contractAccountLinkSelect.value),
                installments: []
            };

            const commissionPerInstallment = (totalValue * (percentage / 100)) / installmentsCount;

            for (let i = 0; i < installmentsCount; i++) {
                const dueDate = new Date(startDate);
                dueDate.setMonth(startDate.getMonth() + i);
                newContract.installments.push({
                    number: i + 1,
                    dueDate: dueDate,
                    amount: commissionPerInstallment,
                    status: 'Pendente' // Pendente, Pago
                });
            }
            userContracts.push(newContract);
            renderContracts();
            addContractForm.reset();
            closeModal(contractModal);
        });

        addClientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newClient = {
                id: Date.now(),
                name: document.getElementById('client-name').value,
                cpfCnpj: document.getElementById('client-cpf-cnpj').value,
                razaoSocial: document.getElementById('client-razao-social').value,
                address: document.getElementById('client-address').value,
            };
            userClients.push(newClient);
            renderClients();
            addClientForm.reset();
        });

        clientCpfCnpjInput.addEventListener('blur', async (e) => {
            const cnpj = e.target.value.replace(/\D/g, '');
            if (cnpj.length === 14) {
                cnpjLoader.classList.remove('hidden');
                cnpjError.classList.add('hidden');
                try {
                    const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                    if (!response.ok) {
                        throw new Error('CNPJ não encontrado ou inválido.');
                    }
                    const data = await response.json();
                    document.getElementById('client-name').value = data.nome_fantasia || '';
                    document.getElementById('client-razao-social').value = data.razao_social || '';
                    document.getElementById('client-address').value = `${data.logradouro}, ${data.numero} - ${data.bairro}, ${data.municipio} - ${data.uf}, ${data.cep}`;
                } catch (error) {
                    cnpjError.textContent = error.message;
                    cnpjError.classList.remove('hidden');
                } finally {
                    cnpjLoader.classList.add('hidden');
                }
            }
        });

        function renderAccounts() {
            accountsListEl.innerHTML = '';
            accountSelectForUpload.innerHTML = '<option value="">-- Selecione --</option>';
            ccAccountLinkSelect.innerHTML = '<option value="">-- Vincular a uma conta --</option>';
            contractAccountLinkSelect.innerHTML = '<option value="">-- Selecione uma conta --</option>';
            
            if (userAccounts.length === 0) {
                accountsListEl.appendChild(noAccountsMessage);
                noAccountsMessage.classList.remove('hidden');
                document.getElementById('upload-button').disabled = true;
            } else {
                noAccountsMessage.classList.add('hidden');
                document.getElementById('upload-button').disabled = false;
            }

            userAccounts.forEach(account => {
                const accountCard = document.createElement('div');
                accountCard.className = 'bg-white p-4 rounded-lg border shadow-sm';
                const currentBalance = account.transactions.reduce((acc, trans) => acc + trans.amount, account.initialBalance);
                accountCard.innerHTML = `
                    <h3 class="font-bold text-lg">${account.name}</h3>
                    <p class="text-sm text-gray-600">${account.bank} - ${account.type}</p>
                    <p class="text-xs text-gray-500 mt-1">Ag: ${account.agency || 'N/A'} | C/C: ${account.accountNumber || 'N/A'}</p>
                    <p class="text-2xl font-semibold mt-2 ${currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(currentBalance)}</p>
                `;
                accountsListEl.appendChild(accountCard);

                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.name} (${account.bank})`;
                accountSelectForUpload.appendChild(option.cloneNode(true));
                ccAccountLinkSelect.appendChild(option.cloneNode(true));
                contractAccountLinkSelect.appendChild(option.cloneNode(true));
            });
        }

        function renderCreditCards() {
            creditCardsListEl.innerHTML = '';
            if (userCreditCards.length === 0) {
                creditCardsListEl.appendChild(noCreditCardsMessage);
                noCreditCardsMessage.classList.remove('hidden');
            } else {
                noCreditCardsMessage.classList.add('hidden');
            }

            userCreditCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bg-white p-4 rounded-lg border shadow-sm';
                cardEl.innerHTML = `
                    <h3 class="font-bold text-lg">${card.description}</h3>
                    <p class="text-sm text-gray-600">${card.brand}</p>
                    <p class="text-xs text-gray-500 mt-1">Limite: ${formatCurrency(card.limit)}</p>
                    <p class="text-xs text-gray-500">Fecha dia ${card.closeDay} | Vence dia ${card.dueDay}</p>
                `;
                creditCardsListEl.appendChild(cardEl);
            });
        }

        function renderGoals() {
            goalsListEl.innerHTML = '';
            if (userGoals.length === 0) {
                goalsListEl.appendChild(noGoalsMessage);
                noGoalsMessage.classList.remove('hidden');
            } else {
                noGoalsMessage.classList.add('hidden');
            }

            userGoals.forEach(goal => {
                const percentage = Math.min((goal.currentAmount / goal.targetAmount) * 100, 100);
                const goalCard = document.createElement('div');
                goalCard.className = 'bg-white p-4 rounded-lg border shadow-sm';
                goalCard.innerHTML = `
                    <h3 class="font-bold text-lg">${goal.name}</h3>
                    <div class="flex justify-between items-center text-sm mt-2">
                        <span class="text-green-600 font-medium">${formatCurrency(goal.currentAmount)}</span>
                        <span class="text-gray-500">${formatCurrency(goal.targetAmount)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <p class="text-right text-xs text-gray-500 mt-1">${percentage.toFixed(1)}%</p>
                `;
                goalsListEl.appendChild(goalCard);
            });
        }

        function renderClients() {
            clientsListEl.innerHTML = '';
            contractClientSelect.innerHTML = '<option value="">-- Selecione um cliente --</option>';

            if (userClients.length === 0) {
                clientsListEl.innerHTML = '<p class="text-gray-500 text-center">Nenhum cliente cadastrado.</p>';
            }

            userClients.forEach(client => {
                const clientItem = document.createElement('div');
                clientItem.className = 'flex justify-between items-center p-2 hover:bg-gray-50';
                clientItem.innerHTML = `<div><p class="font-medium">${client.name}</p><p class="text-xs text-gray-500">${client.cpfCnpj || ''}</p></div>`;
                clientsListEl.appendChild(clientItem);

                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                contractClientSelect.appendChild(option);
            });
        }

        function renderContracts() {
            contractsListEl.innerHTML = '';
            if (userContracts.length === 0) {
                contractsListEl.appendChild(noContractsMessage);
                noContractsMessage.classList.remove('hidden');
            } else {
                noContractsMessage.classList.add('hidden');
            }

            userContracts.forEach(contract => {
                const client = userClients.find(c => c.id === contract.clientId);
                const totalCommission = (contract.totalValue * contract.commissionPercentage) / 100;
                const contractCard = document.createElement('div');
                contractCard.className = 'bg-white p-4 rounded-lg border shadow-sm';
                contractCard.innerHTML = `
                    <h3 class="font-bold text-lg">Contrato: ${client ? client.name : 'Cliente não encontrado'}</h3>
                    <p class="text-sm text-gray-600">Valor Total: ${formatCurrency(contract.totalValue)}</p>
                    <p class="text-sm text-green-600">Comissão Total: ${formatCurrency(totalCommission)} (${contract.commissionPercentage}%)</p>
                    <button data-contract-id="${contract.id}" class="view-contract-details-btn mt-2 text-sm text-blue-600 hover:underline">Ver Detalhes</button>
                `;
                contractsListEl.appendChild(contractCard);
            });

            document.querySelectorAll('.view-contract-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const contractId = parseInt(e.target.dataset.contractId);
                    const contract = userContracts.find(c => c.id === contractId);
                    renderContractDetails(contract);
                    openModal(contractDetailsModal);
                });
            });
        }

        function renderContractDetails(contract) {
            const client = userClients.find(c => c.id === contract.clientId);
            document.getElementById('contract-details-title').textContent = `Detalhes do Contrato - ${client.name}`;
            const installmentsListEl = document.getElementById('installments-list');
            installmentsListEl.innerHTML = '';

            contract.installments.forEach(inst => {
                const item = document.createElement('div');
                item.className = 'p-3 border-b flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-medium">Parcela ${inst.number} / ${contract.installmentsCount}</p>
                        <p class="text-sm text-gray-600">Vencimento: ${inst.dueDate.toLocaleDateString('pt-BR')}</p>
                        <p class="text-sm text-green-600">Comissão: ${formatCurrency(inst.amount)}</p>
                    </div>
                    <div>
                        ${inst.status === 'Pendente' ? 
                            `<button data-contract-id="${contract.id}" data-installment-number="${inst.number}" class="mark-paid-btn bg-green-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-green-600">Confirmar Recebimento</button>` :
                            `<span class="text-xs font-bold text-gray-500 bg-gray-200 py-1 px-2 rounded">Recebido</span>`
                        }
                    </div>
                `;
                installmentsListEl.appendChild(item);
            });

            document.querySelectorAll('.mark-paid-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const contractId = parseInt(e.target.dataset.contractId);
                    const installmentNumber = parseInt(e.target.dataset.installmentNumber);
                    
                    const targetContract = userContracts.find(c => c.id === contractId);
                    const targetInstallment = targetContract.installments.find(i => i.number === installmentNumber);
                    
                    if (targetInstallment && targetInstallment.status === 'Pendente') {
                        targetInstallment.status = 'Pago';
                        
                        const targetAccount = userAccounts.find(acc => acc.id === targetContract.linkedAccountId);
                        if(targetAccount) {
                            const today = new Date();
                             const newTransaction = {
                                id: `inst-${targetContract.id}-${targetInstallment.number}`,
                                amount: targetInstallment.amount,
                                description: `Comissão Parcela ${targetInstallment.number}/${targetContract.installmentsCount} - ${client.name}`,
                                date: today.toLocaleDateString('pt-BR'),
                                rawDate: `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`,
                                category: 'Outras Receitas'
                            };
                            targetAccount.transactions.push(newTransaction);
                            targetAccount.transactions.sort((a, b) => b.rawDate.localeCompare(a.rawDate));
                            renderAccounts();
                            updateDashboard();
                        }
                        renderContractDetails(targetContract); // Re-renderiza o modal
                    }
                });
            });
        }

        // --- Lógica do Gerenciador Financeiro ---
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('ofx-file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const transactionsSection = document.getElementById('transactions-section');
        const transactionsTable = document.getElementById('transactions-table');
        const transactionsBody = document.getElementById('transactions-body');
        const noTransactionsMessage = document.getElementById('no-transactions');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const hideCategorizedToggle = document.getElementById('hide-categorized-toggle');
        
        const paginationControls = document.getElementById('pagination-controls');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');
        
        const monthDisplay = document.getElementById('month-display');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');

        const planningForm = document.getElementById('planning-form');
        const monthlyIncomeInput = document.getElementById('monthly-income');
        const planningCategoryList = document.getElementById('planning-category-list');
        const planningTotalPlannedEl = document.getElementById('planning-total-planned');
        const planningBudgetTotalEl = document.getElementById('planning-budget-total');
        const planningSuccessMessage = document.getElementById('planning-success-message');

        const settingsForm = document.getElementById('settings-form');
        const settingsAppearance = document.getElementById('setting-appearance');
        const settingsSuccessMessage = document.getElementById('settings-success-message');

        const reportCategoryList = document.getElementById('report-category-list');
        const reportMonthDisplay = document.getElementById('report-month-display');
        const prevReportMonthBtn = document.getElementById('prev-report-month-btn');
        const nextReportMonthBtn = document.getElementById('next-report-month-btn');

        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        hideCategorizedToggle.addEventListener('change', filterCategorizedTransactions);
        
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                const targetAccount = userAccounts.find(acc => acc.id === currentAccountId);
                displayTransactions(targetAccount.transactions);
            }
        });
        nextPageBtn.addEventListener('click', () => {
            const targetAccount = userAccounts.find(acc => acc.id === currentAccountId);
            const totalPages = Math.ceil(targetAccount.transactions.length / TRANSACTIONS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                displayTransactions(targetAccount.transactions);
            }
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
            const targetAccount = userAccounts.find(acc => acc.id === currentAccountId);
            if (targetAccount) displayTransactions(targetAccount.transactions);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
            const targetAccount = userAccounts.find(acc => acc.id === currentAccountId);
            if (targetAccount) displayTransactions(targetAccount.transactions);
        });

        prevReportMonthBtn.addEventListener('click', () => {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
            updateReportView();
        });
        nextReportMonthBtn.addEventListener('click', () => {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
            updateReportView();
        });

        function autoCategorize(description) {
            const upperDescription = description.toUpperCase();
            for (const category of CATEGORIES) {
                if (AUTO_CATEGORIZATION_MAP[category.name]) {
                    for (const keyword of AUTO_CATEGORIZATION_MAP[category.name]) {
                        if (upperDescription.includes(keyword)) { return category.name; }
                    }
                }
            }
            return 'Não categorizado';
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            currentAccountId = parseInt(accountSelectForUpload.value);

            if (!file) return;
            if (!currentAccountId) {
                alert("Por favor, selecione uma conta antes de importar o extrato.");
                return;
            }

            resetOFXUI();
            fileNameDisplay.textContent = `Arquivo: ${file.name}`;
            loadingSpinner.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    setTimeout(() => parseOfx(e.target.result, currentAccountId), 500);
                } catch (error) {
                    showError("Ocorreu um erro ao ler o arquivo.");
                }
            };
            reader.onerror = () => showError("Não foi possível ler o arquivo.");
            reader.readAsText(file, 'UTF-8');
        }

        function parseOfx(ofxContent, accountId) {
            try {
                const xmlContent = `<OFX>${ofxContent.split('<OFX>')[1]}`;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "application/xml");
                if (xmlDoc.getElementsByTagName("parsererror").length) throw new Error("O arquivo não parece ser um OFX ou XML válido.");
                
                const orgNameFromOfx = xmlDoc.getElementsByTagName('ORG')[0]?.textContent.trim().toUpperCase();
                const targetAccount = userAccounts.find(acc => acc.id === accountId);
                if (!targetAccount) throw new Error("Conta selecionada não encontrada.");
                const bankNameFromAccount = targetAccount.bank.trim().toUpperCase();

                if (orgNameFromOfx && !orgNameFromOfx.includes(bankNameFromAccount) && !bankNameFromAccount.includes(orgNameFromOfx)) {
                    throw new Error(`Este extrato é do "${xmlDoc.getElementsByTagName('ORG')[0]?.textContent}", mas a conta selecionada é do "${targetAccount.bank}". Por favor, selecione a conta correta.`);
                }

                const ofxTransactions = xmlDoc.getElementsByTagName('STMTTRN');
                if (ofxTransactions.length === 0) throw new Error("Nenhuma transação encontrada no arquivo.");
                
                let newTransactionsCount = 0;
                for (const transaction of ofxTransactions) {
                    const fitId = transaction.getElementsByTagName('FITID')[0]?.textContent;
                    if (targetAccount.transactions.some(t => t.id === fitId)) {
                        continue;
                    }
                    
                    const amount = parseFloat(transaction.getElementsByTagName('TRNAMT')[0]?.textContent);
                    const memo = transaction.getElementsByTagName('MEMO')[0]?.textContent;
                    const datePosted = transaction.getElementsByTagName('DTPOSTED')[0]?.textContent;

                    if (!amount || !memo || !datePosted) continue;

                    targetAccount.transactions.push({
                        id: fitId,
                        amount: amount,
                        description: memo,
                        date: `${datePosted.substring(6, 8)}/${datePosted.substring(4, 6)}/${datePosted.substring(0, 4)}`,
                        rawDate: datePosted.substring(0, 8),
                        category: autoCategorize(memo)
                    });
                    newTransactionsCount++;
                }
                
                targetAccount.transactions.sort((a, b) => b.rawDate.localeCompare(a.rawDate));
                
                if(targetAccount.transactions.length > 0) {
                    const latestDate = targetAccount.transactions[0].rawDate;
                    currentDisplayDate = new Date(latestDate.substring(0,4), latestDate.substring(4,6) - 1, 1);
                }

                currentPage = 1;
                displayTransactions(targetAccount.transactions);
                renderAccounts(); 
                updateDashboard();
                filterCategorizedTransactions();

            } catch (error) {
                console.error("Erro no parsing do OFX:", error);
                showError(error.message || "Erro ao processar o arquivo.");
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function displayTransactions(accountTransactions) {
            transactionsBody.innerHTML = '';
            
            updateMonthNavigator();

            const filteredTransactions = accountTransactions.filter(t => {
                const transactionDate = new Date(t.rawDate.substring(0,4), t.rawDate.substring(4,6) - 1, t.rawDate.substring(6,8));
                return transactionDate.getMonth() === currentDisplayDate.getMonth() && transactionDate.getFullYear() === currentDisplayDate.getFullYear();
            });

            if (!filteredTransactions || filteredTransactions.length === 0) {
                noTransactionsMessage.textContent = `Nenhum resultado para ${currentDisplayDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}.`;
                noTransactionsMessage.classList.remove('hidden');
                transactionsTable.classList.add('hidden');
                paginationControls.classList.add('hidden');
                return;
            }

            const totalPages = Math.ceil(filteredTransactions.length / TRANSACTIONS_PER_PAGE);
            const startIndex = (currentPage - 1) * TRANSACTIONS_PER_PAGE;
            const endIndex = startIndex + TRANSACTIONS_PER_PAGE;
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);

            const groupedByDate = paginatedTransactions.reduce((acc, trans) => {
                const date = trans.date;
                if (!acc[date]) {
                    acc[date] = { transactions: [], totalIncome: 0, totalExpenses: 0 };
                }
                acc[date].transactions.push(trans);
                if (trans.amount > 0) acc[date].totalIncome += trans.amount;
                else acc[date].totalExpenses += trans.amount;
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.split('/').reverse().join('').localeCompare(a.split('/').reverse().join('')));

            sortedDates.forEach(date => {
                const group = groupedByDate[date];
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'bg-gray-100 summary-row';
                const formattedIncome = formatCurrency(group.totalIncome);
                const formattedExpenses = formatCurrency(Math.abs(group.totalExpenses));
                summaryRow.innerHTML = `<td class="px-6 py-2 text-sm font-bold" colspan="2">${date}</td><td class="px-6 py-2 text-sm font-bold text-right" colspan="2"><span class="text-green-600 mr-4">Entradas: ${formattedIncome}</span><span class="text-red-600">Saídas: ${formattedExpenses}</span></td>`;
                transactionsBody.appendChild(summaryRow);

                group.transactions.forEach(trans => {
                    const row = document.createElement('tr');
                    row.dataset.transactionId = trans.id;
                    const amountColor = trans.amount < 0 ? 'text-red-600' : 'text-green-600';
                    const formattedAmount = formatCurrency(trans.amount);
                    const optionsHtml = ['Não categorizado', ...CATEGORIES.map(c => c.name)]
                        .map(name => `<option value="${name}">${name}</option>`).join('');

                    row.innerHTML = `
                        <td class="px-6 py-4"></td>
                        <td class="px-6 py-4 text-sm text-gray-800 font-medium">${trans.description}</td>
                        <td class="px-6 py-4 text-sm text-right font-semibold ${amountColor}">${formattedAmount}</td>
                        <td class="px-6 py-4 text-sm">
                            <select class="category-select bg-white border border-gray-300 rounded-md shadow-sm p-1 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            ${optionsHtml}
                            </select>
                        </td>
                    `;
                    const selectElement = row.querySelector('.category-select');
                    selectElement.value = trans.category;
                    selectElement.addEventListener('change', (event) => {
                        trans.category = event.target.value;
                        updateDashboard();
                        if (hideCategorizedToggle.checked && trans.category !== 'Não categorizado') {
                            event.target.closest('tr').classList.add('hidden');
                        }
                    });
                    transactionsBody.appendChild(row);
                });
            });

            noTransactionsMessage.classList.add('hidden');
            transactionsTable.classList.remove('hidden');
            renderPaginationControls(totalPages);
        }
        
        function updateMonthNavigator() {
            const monthName = currentDisplayDate.toLocaleString('pt-BR', { month: 'long' });
            monthDisplay.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${currentDisplayDate.getFullYear()}`;
        }

        function renderPaginationControls(totalPages) {
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }
            paginationControls.classList.remove('hidden');
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        function filterCategorizedTransactions() {
            const isChecked = hideCategorizedToggle.checked;
            transactionsBody.querySelectorAll('tr').forEach(row => {
                if (row.classList.contains('summary-row')) {
                    row.classList.remove('hidden');
                    return;
                }
                const category = row.querySelector('.category-select')?.value;
                if (isChecked && category && category !== 'Não categorizado') {
                    row.classList.add('hidden');
                } else {
                    row.classList.remove('hidden');
                }
            });
        }
        
        function updateDashboard() {
            updateSummaryDashboard();
            updateCharts();
        }

        function updateSummaryDashboard() {
            const allTransactions = userAccounts.flatMap(acc => acc.transactions);
            
            let totalIncome = 0;
            let totalExpenses = 0;
            let creditCardExpenses = 0;

            allTransactions.forEach(trans => {
                if (trans.amount > 0) {
                    totalIncome += trans.amount;
                } else {
                    totalExpenses += trans.amount;
                }
            });

            const creditCardAccounts = userAccounts.filter(acc => acc.type === 'Cartão de Crédito');
            creditCardAccounts.forEach(acc => {
                acc.transactions.forEach(trans => {
                    if (trans.amount < 0) {
                        creditCardExpenses += trans.amount;
                    }
                });
            });

            const totalInitialBalance = userAccounts.reduce((sum, acc) => sum + acc.initialBalance, 0);
            const currentTotalBalance = totalInitialBalance + totalIncome + totalExpenses;

            document.getElementById('summary-balance').textContent = formatCurrency(currentTotalBalance);
            document.getElementById('summary-income').textContent = formatCurrency(totalIncome);
            document.getElementById('summary-expenses').textContent = formatCurrency(Math.abs(totalExpenses));
            document.getElementById('summary-credit-card').textContent = formatCurrency(Math.abs(creditCardExpenses));
        }

        function updateCharts() {
            const allTransactions = userAccounts.flatMap(acc => acc.transactions);
            const expenseCategoryTotals = {};
            const incomeCategoryTotals = {};
            let totalExpenses = 0;
            let totalIncome = 0;

            allTransactions.forEach(trans => {
                if (trans.amount < 0) {
                    totalExpenses += Math.abs(trans.amount);
                    if (trans.category !== 'Não categorizado') {
                        expenseCategoryTotals[trans.category] = (expenseCategoryTotals[trans.category] || 0) + Math.abs(trans.amount);
                    }
                } else {
                    totalIncome += trans.amount;
                    if (trans.category !== 'Não categorizado') {
                        incomeCategoryTotals[trans.category] = (incomeCategoryTotals[trans.category] || 0) + trans.amount;
                    }
                }
            });

            renderExpenseChart(Object.keys(expenseCategoryTotals), Object.values(expenseCategoryTotals));
            renderIncomeChart(Object.keys(incomeCategoryTotals), Object.values(incomeCategoryTotals));
            renderBalanceChart(totalIncome, totalExpenses);
        }
        
        function renderChart(canvas, noDataEl, chartInstance, config) {
            const hasData = config.data.labels.length > 0 && config.data.datasets[0].data.reduce((a, b) => a + b, 0) > 0;
            if (!hasData) {
                noDataEl.classList.remove('hidden');
                canvas.classList.add('hidden');
                if (chartInstance) chartInstance.destroy();
                return null;
            }
            noDataEl.classList.add('hidden');
            canvas.classList.remove('hidden');
            if (chartInstance) chartInstance.destroy();
            const ctx = canvas.getContext('2d');
            return new Chart(ctx, config);
        }

        function renderExpenseChart(labels, data) { const config = { type: 'pie', data: { labels: labels, datasets: [{ label: 'Despesas', data: data, backgroundColor: ['#FF6384', '#FF9F40', '#FFCD56', '#C84B31', '#D44000', '#E56717'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } }; expenseChart = renderChart(document.getElementById('expense-chart'), document.getElementById('no-expense-data'), expenseChart, config); }
        function renderIncomeChart(labels, data) { const config = { type: 'pie', data: { labels: labels, datasets: [{ label: 'Receitas', data: data, backgroundColor: ['#4BC0C0', '#36A2EB', '#9966FF', '#46BFBD', '#5AD3D1', '#2B7A78'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } }; incomeChart = renderChart(document.getElementById('income-chart'), document.getElementById('no-income-data'), incomeChart, config); }
        function renderBalanceChart(income, expenses) { const config = { type: 'doughnut', data: { labels: ['Receitas', 'Despesas'], datasets: [{ label: 'Balanço', data: [income, Math.abs(expenses)], backgroundColor: ['#4BC0C0', '#FF6384'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } }; balanceChart = renderChart(document.getElementById('balance-chart'), document.getElementById('no-balance-data'), balanceChart, config); }
        
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function showError(message) { errorText.textContent = message; errorMessage.classList.remove('hidden'); loadingSpinner.classList.add('hidden'); transactionsTable.classList.add('hidden'); noTransactionsMessage.classList.remove('hidden'); }
        function resetOFXUI() { errorMessage.classList.add('hidden'); noTransactionsMessage.classList.remove('hidden'); transactionsTable.classList.add('hidden'); transactionsBody.innerHTML = ''; fileNameDisplay.textContent = 'Nenhum arquivo selecionado.'; hideCategorizedToggle.checked = false; paginationControls.classList.add('hidden');}
        
        function calculatePlanning() {
            const income = parseFloat(monthlyIncomeInput.value) || 0;
            monthlyPlan.income = income;
            
            let totalPlanned = 0;
            document.querySelectorAll('.planning-category-input').forEach(input => {
                const value = parseFloat(input.value) || 0;
                totalPlanned += value;
                monthlyPlan.categoryBudgets[input.dataset.category] = value;
            });
            
            planningTotalPlannedEl.textContent = formatCurrency(totalPlanned);
            planningBudgetTotalEl.textContent = formatCurrency(income);

            renderPlanningChart(totalPlanned, income);
        }

        planningForm.addEventListener('submit', (e) => {
            e.preventDefault();
            calculatePlanning(); // Garante que os dados mais recentes sejam salvos
            planningSuccessMessage.classList.remove('hidden');
            setTimeout(() => planningSuccessMessage.classList.add('hidden'), 3000);
        });
        monthlyIncomeInput.addEventListener('input', calculatePlanning);

        function renderPlanningCategories() {
            planningCategoryList.innerHTML = '';
            const expenseCategories = CATEGORIES.filter(c => c.type === 'expense');
            expenseCategories.forEach(category => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">${category.name}</label>
                    <input type="number" data-category="${category.name}" class="planning-category-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="R$ 0,00">
                `;
                planningCategoryList.appendChild(div);
            });

            document.querySelectorAll('.planning-category-input').forEach(input => {
                input.addEventListener('input', calculatePlanning);
            });
        }

        function renderPlanningChart(planned, total) {
            const remaining = Math.max(0, total - planned);
            const data = {
                labels: ['Planejado', 'Restante'],
                datasets: [{
                    data: [planned, remaining],
                    backgroundColor: ['#4f46e5', '#e5e7eb'],
                    borderWidth: 0,
                }]
            };
            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false } }
                }
            };
            if (planningChart) planningChart.destroy();
            planningChart = new Chart(document.getElementById('planning-chart').getContext('2d'), config);
        }

        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const appearance = settingsAppearance.value;
            if (appearance === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            settingsSuccessMessage.classList.remove('hidden');
            setTimeout(() => settingsSuccessMessage.classList.add('hidden'), 3000);
        });

        function updateReportView() {
            const monthName = currentDisplayDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            reportMonthDisplay.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;

            const allTransactions = userAccounts.flatMap(acc => acc.transactions);
            const monthlyTransactions = allTransactions.filter(t => {
                const transactionDate = new Date(t.rawDate.substring(0,4), t.rawDate.substring(4,6) - 1, t.rawDate.substring(6,8));
                return transactionDate.getMonth() === currentDisplayDate.getMonth() && transactionDate.getFullYear() === currentDisplayDate.getFullYear();
            });

            const expenseTotals = {};
            const expenseCategories = CATEGORIES.filter(c => c.type === 'expense');
            expenseCategories.forEach(cat => expenseTotals[cat.name] = 0);

            monthlyTransactions.forEach(t => {
                if(t.amount < 0 && expenseTotals.hasOwnProperty(t.category)) {
                    expenseTotals[t.category] += Math.abs(t.amount);
                }
            });

            reportCategoryList.innerHTML = '';
            expenseCategories.forEach(cat => {
                const planned = monthlyPlan.categoryBudgets[cat.name] || 0;
                const spent = expenseTotals[cat.name];
                const percentage = planned > 0 ? Math.min((spent / planned) * 100, 100) : 0;
                
                const item = document.createElement('div');
                item.className = 'mb-4';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-medium">${cat.name}</span>
                        <span>${formatCurrency(spent)} / ${formatCurrency(planned)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
                reportCategoryList.appendChild(item);
            });

            renderReportChart(Object.keys(expenseTotals), Object.values(expenseTotals));
        }

        function renderReportChart(labels, data) {
            const config = {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#FF6384', '#FF9F40', '#FFCD56', '#4BC0C0', '#9966FF', '#36A2EB', '#C84B31', '#D44000'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            };
            reportChart = renderChart(document.getElementById('report-chart'), document.getElementById('no-report-data'), reportChart, config);
        }
        
        // --- Categorias (CRUD e UI) ---
        function renderCategories() {
            categoriesListEl.innerHTML = '';

            if (!Array.isArray(CATEGORIES) || CATEGORIES.length === 0) {
                categoriesListEl.innerHTML = '<p class="text-gray-500">Nenhuma categoria cadastrada.</p>';
                return;
            }

            CATEGORIES.forEach(cat => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-3 rounded border bg-white';
                row.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="inline-block w-4 h-4 rounded" style="background-color:${cat.color}"></span>
                    <div>
                    <p class="font-medium">${cat.name}</p>
                    <p class="text-xs text-gray-500">${cat.type === 'expense' ? 'Despesa' : 'Receita'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button class="edit-cat px-3 py-1 text-sm rounded bg-indigo-600 text-white hover:bg-indigo-700" data-id="${cat.id}">Editar</button>
                    <button class="del-cat px-3 py-1 text-sm rounded bg-red-600 text-white hover:bg-red-700" data-id="${cat.id}">Excluir</button>
                </div>
                `;
                categoriesListEl.appendChild(row);
            });

            // Ações
            categoriesListEl.querySelectorAll('.edit-cat').forEach(btn => {
                btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                const cat = CATEGORIES.find(c => c.id === id);
                openCategoryModal(cat);
                });
            });

            categoriesListEl.querySelectorAll('.del-cat').forEach(btn => {
                btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                CATEGORIES = CATEGORIES.filter(c => c.id !== id);
                renderCategories();
                renderPlanningCategories();
                updateDashboard();
                });
            });
        }

        function openCategoryModal(category = null) {
            document.getElementById('category-modal-title').textContent =
                category ? 'Editar Categoria' : 'Adicionar Nova Categoria';
            document.getElementById('category-id').value = category ? category.id : '';
            document.getElementById('category-name').value = category ? category.name : '';
            document.getElementById('category-type').value = category ? category.type : 'expense';
            document.getElementById('category-color').value = category ? category.color : '#FF6384';
            openModal(categoryModal);
        }
        
        addCategoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value.trim();
            const type = document.getElementById('category-type').value;
            const color = document.getElementById('category-color').value;

            if (!name) return;

            if (id) {
                const idx = CATEGORIES.findIndex(c => String(c.id) === String(id));
                if (idx >= 0) {
                CATEGORIES[idx] = { ...CATEGORIES[idx], name, type, color };
                }
            } else {
                const newCat = { id: Date.now(), name, type, color };
                CATEGORIES.push(newCat);
            }

            renderCategories();
            renderPlanningCategories();
            updateDashboard();
            addCategoryForm.reset();
            closeModal(categoryModal);
        });

        // Inicialização
        function initializeApp() {
            fetchBanks();
            bankSearchInput.addEventListener('input', (e) => renderBankList(e.target.value));
            renderAccounts();
            renderCreditCards();
            renderGoals();
            renderPlanningCategories();
            renderClients();
            renderCategories();
            updateDashboard();
            showContent('dashboard-content');
        }

        function renderBankList(filter = '') {
            bankListEl.innerHTML = '';
            const filteredBanks = ALL_BANKS.filter(bank => bank && bank.name && bank.name.toLowerCase().includes(filter.toLowerCase()));

            filteredBanks.forEach(bank => {
                const bankItem = document.createElement('div');
                bankItem.className = 'flex items-center p-3 hover:bg-gray-100 rounded-lg cursor-pointer';
                bankItem.innerHTML = `<div class="w-8 h-8 mr-4 flex items-center justify-center text-gray-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg></div><span class="font-medium">${bank.name}</span>`;
                bankItem.addEventListener('click', () => {
                    document.getElementById('account-bank').value = bank.name;
                    modalStep1.classList.add('hidden');
                    modalStep2.classList.remove('hidden');
                });
                bankListEl.appendChild(bankItem);
            });
        }

        async function fetchBanks() {
            try {
                const response = await fetch('https://brasilapi.com.br/api/banks/v1');
                if (!response.ok) {
                    throw new Error('Não foi possível buscar a lista de bancos.');
                }
                ALL_BANKS = await response.json();
            } catch (error) {
                console.error(error);
                ALL_BANKS = []; // Inicia vazio se a API falhar
            } finally {
                renderBankList();
            }
        }
        
        initializeApp();

    </script>
</body>
</html>
